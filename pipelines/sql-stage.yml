
parameters:
- name: databaseName
  type: string
  

- name: userName
  type: string

- name: password
  type: string

- name: azureSubscription
  type: string

- name: serverName
  type: string

- name: resourceGroupName
  type: string  

- name: serverFqdn
  type: string

- name: dependsOn
  type: string
  default: ''  

stages:
- stage: deploy_sql_content
  displayName: create and push sql database
  dependsOn: ${{parameters.dependsOn}}
  jobs :
  - job: deploy_sql_content
    steps:
    #open the firewall of the sql server 
    - task: AzurePowerShell@5
      displayName: open sql server firewall
      inputs:
        azureSubscription: ${{parameters.azureSubscription}}
        ScriptPath: 'content\sql-content\set-azure-firewall-rule.ps1'
        ScriptArguments: "-ServerName ${{ parameters.serverName }} -ResourceGroup ${{ parameters.resourceGroupName }}"
        azurePowerShellVersion: LatestVersion

    #execute the sql script
    - task: CmdLine@1
      displayName: execute sql script
      inputs:
        filename: Sqlcmd
        arguments: '-S ${{parameters.serverFqdn}} -U ${{parameters.userName}} -P ${{parameters.password}} -d ${{parameters.databaseName}} -i "$(Build.SourcesDirectory)\\content\\sql-content\\database.sql"'

    #close the sql firewall
    - task: AzurePowerShell@5
      displayName: close sql server firewall
      inputs:
        azureSubscription: ${{parameters.azureSubscription}}
        ScriptPath: 'content\sql-content\remove-azure-firewall.ps1'
        ScriptArguments: "${{parameters.serverName}} -ResourceGroup ${{parameters.resourceGroupName}}"
        azurePowerShellVersion: LatestVersion


