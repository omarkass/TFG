# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml
parameters:
  - name: resourceGroup
    type: string
    default: "proj-dev-func-rg"
    

  - name: resoucType
    type: string
    default: "microsoft.web/sites"
    
  - name: tagValue
    type: string
    default: "proj"

  - name: dependsOn
    type: string
    default: ''  
    
  - name: azureSubscription
    type: string


stages:

  - stage: firststage
    dependsOn : ${{parameters.dependsOn}}
    jobs:

      - job: firstjob
        pool:
          vmImage: 'windows-latest'
        steps:
        - task: AzureCLI@2
          inputs:
            azureSubscription: ${{ parameters.azureSubscription }}
            scriptType: 'ps'
            scriptLocation: 'inlineScript'
            inlineScript: |
              $resources = $(az resource list --tag deployedby="${{parameters.tagValue}}" ) | ConvertFrom-json
              foreach( $resource in $resources  ) { 
               if($resource.type -eq "${{parameters.resoucType}}" -and $resource.resourceGroup -eq "${{parameters.resourceGroup}}")
               {
               mkdir -p $(Pipeline.Workspace)/variables
               echo $resource.name > $(Pipeline.Workspace)/variables/FOO
               echo $resource.name
               }
               }
        - publish: $(Pipeline.Workspace)/variables
          artifact: variables
